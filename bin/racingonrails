require 'fileutils'

include FileUtils

Signal.trap("INT") { puts; exit }

freeze   = ARGV.any? { |option| %w(--freeze -f).include?(option) }
app_path = ARGV.first
template_root = File.expand_path(File.dirname(__FILE__) + '/..'

# Create new Rails app
puts(`rails #{app_path}`)

# Remove homepage -- index requests will be handled by controller
rm("#{app_path}/public/index.html")

# Uncomment default routing and change to 'home' controller
# TODO Extract this code into generic method -- probably not using text Rakefile, but separate file
routes_path = File.expand_path("#{app_path}/config/routes.rb")
routes_text = IO.read(routes_path)
routes_text.gsub!(%q{# map.connect '', :controller => "welcome"}, %q{map.connect '', :controller => "home"})
File.open(routes_path, 'w') {|io|
  io << routes_text
}

# Add ASSOCIATION default to environment
routes_path = File.expand_path("#{app_path}/config/environment.rb")
routes_text = IO.read(routes_path)
routes_text.gsub!(
  %q{# Include your application configuration below}, 
  %q{# Include your application configuration below
    require 'racing_on_rails'
    ASSOCIATION = Association.new})
File.open(routes_path, 'w') {|io|
  io << routes_text
}

# Racing on Rails default 'Rails' classess
copy_templates('/app/controllers')
copy_templates('/app/helpers')
copy_templates('/app/models')
copy_templates('/app/views')

# Default theme
copy_templates('/public/images/backgrounds')
copy_template('/public/stylesheets/racing_on_rails.css')

# TODO Setup database

def copy_template(file_path)
  cp(template_root + file_path, app_path + file)
end

def copy_templates(dir_path)
  cp_r(template_root + dir_path, app_path + dir_path)
end